{% extends "layout.html" %}
{% block content %}
<div class="container-fluid py-3 px-2">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <h2 class="fw-900 uppercase text-accent m-0 fs-4">Admin Scoring</h2>
        <form action="{{ url_for('admin_scoring') }}" method="POST" class="w-100 w-md-auto">
            <input type="hidden" name="sync_all" value="1">
            <button type="submit" class="btn btn-outline-light btn-sm fw-900 uppercase ls-1 w-100">Sync Cast</button>
        </form>
    </div>

    <div class="pro-card p-2 p-md-4 border-secondary bg-black">
        <form action="{{ url_for('admin_scoring') }}" method="POST" id="mainScoringForm">
            <div class="row mb-3 align-items-end g-2">
                <div class="col-6 col-md-3">
                    <label class="x-small fw-900 uppercase text-white-50 mb-1 d-block">Week #</label>
                    <input type="number" name="week_num" id="week_num" class="form-control bg-black text-white border-secondary" value="{{ week or 1 }}" required {% if is_locked %}disabled{% endif %}>
                </div>
                <div class="col-12 col-md-9 text-md-end">
                    <div class="d-flex flex-wrap gap-1 justify-content-md-end">
                        {% for key, val in config.items() %}
                            <span class="badge bg-dark border border-secondary" style="font-size: 0.55rem;">
                                {{ key[:5]|upper }}: {{ val }}
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="table-responsive border-top border-secondary" style="max-height: 65vh; overflow-y: auto;">
                <table class="table table-dark table-hover align-middle m-0" id="scoringTable">
                    <thead class="sticky-top bg-black" style="z-index: 10;">
                        <tr class="x-small fw-900 uppercase ls-1 border-bottom border-white">
                            <th class="sticky-col bg-black py-3">Survivor</th>
                            <th class="text-center text-danger">Out</th>
                            <th class="text-center">Surv</th>
                            <th class="text-center">Imm</th>
                            <th class="text-center">Rew</th>
                            <th class="text-center text-accent">Adv+</th>
                            <th class="text-center text-info">JRN</th>
                            <th class="text-center text-warning">PKT</th>
                            <th class="text-center">Mrg</th>
                            <th class="text-center">F5</th>
                            <th class="text-center">F3</th>
                            <th class="text-center text-accent">WIN</th>
                            <th class="text-center text-info">CRY</th>
                            <th class="text-center text-danger">QUIT</th>
                            <th class="text-center text-white-50">Pts</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in survivors if not s.is_out %}
                        <tr class="border-bottom border-secondary-subtle" id="row-{{ s.id }}">
                            <td class="sticky-col bg-black fw-bold text-white small">{{ s.name.split(' ')[0] }}</td>

                            <td class="text-center p-3">
                                <input type="checkbox" name="voted_out_{{ s.id }}" class="form-check-input border-danger" {% if is_locked %}disabled{% endif %}>
                            </td>

                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="survived" {% if is_locked %}disabled{% endif %} checked></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="immunity" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="reward" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="advantage" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="journey" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check border-warning" data-p-id="{{ s.id }}" data-cat="in_pocket" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="merge" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="f5" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check" data-p-id="{{ s.id }}" data-cat="f3" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check border-accent" data-p-id="{{ s.id }}" data-cat="winner" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check border-info" data-p-id="{{ s.id }}" data-cat="crying" {% if is_locked %}disabled{% endif %}></td>
                            <td class="text-center p-3"><input type="checkbox" class="form-check-input live-check border-danger" data-p-id="{{ s.id }}" data-cat="quit" {% if is_locked %}disabled{% endif %}></td>

                            <td class="text-center p-3 fw-bold text-accent"><span id="total-{{ s.id }}">{{ s.points|round(1) }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-3 sticky-bottom bg-black py-2">
                {% if is_locked %}
                <div class="alert alert-secondary text-center fw-900 uppercase ls-1">Week {{ week }} is Finalized ðŸ”’</div>
                {% else %}
                <button type="submit" class="btn btn-accent w-100 fw-900 py-3 uppercase ls-2 shadow-lg">Commit Scores ðŸ”’</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<style>
    .sticky-col {
        position: sticky;
        left: 0;
        z-index: 5;
        border-right: 2px solid #ffffff !important;
        min-width: 90px;
        max-width: 110px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .form-check-input {
        width: 1.5rem;
        height: 1.5rem;
        background-color: #000;
        border: 2px solid #555;
        margin: 0;
        cursor: pointer;
    }

    .form-check-input.border-warning:checked {
        background-color: #ffc107;
        border-color: #fff;
    }

    .form-check-input:checked {
        background-color: var(--accent);
        border-color: #fff;
    }

    td { cursor: pointer; transition: background 0.2s; }
    td:hover { background: rgba(255, 255, 255, 0.1) !important; }

    .table-responsive::-webkit-scrollbar { height: 6px; }
    .table-responsive::-webkit-scrollbar-thumb { background: var(--accent); }

    @media (max-width: 768px) {
        .pro-card { border-radius: 0; border-inline: none; }
    }
</style>

<script>
    // 1. LIVE SCORING LOGIC
    document.querySelectorAll('.live-check').forEach(box => {
        box.addEventListener('change', function() {
            const pId = this.dataset.pId;
            const category = this.dataset.cat;
            const weekNum = document.getElementById('week_num').value;
            const isChecked = this.checked;

            // Visual feedback
            const row = document.getElementById(`row-${pId}`);
            row.style.opacity = '0.6';

            fetch("{{ url_for('toggle_live_score') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    player_id: pId,
                    week: weekNum,
                    category: category,
                    state: isChecked
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`total-${pId}`).innerText = data.new_total;
                } else {
                    alert("Update failed: " + (data.error || "Unknown error"));
                    this.checked = !isChecked; // Revert
                }
                row.style.opacity = '1';
            })
            .catch(err => {
                console.error(err);
                alert("Connection error.");
                row.style.opacity = '1';
                this.checked = !isChecked;
            });
        });
    });

    // 2. CELL-CLICK TOGGLE (Keeping your existing logic)
    document.querySelectorAll('#scoringTable td').forEach(cell => {
        cell.addEventListener('click', function(e) {
            if (this.classList.contains('sticky-col')) return;
            if (e.target.type === 'checkbox') return;

            const cb = this.querySelector('input[type="checkbox"]');
            if (cb && !cb.disabled) {
                cb.checked = !cb.checked;
                // Trigger the 'change' event manually so the Live Update script fires
                cb.dispatchEvent(new Event('change'));
                this.style.backgroundColor = cb.checked ? 'rgba(255,204,0,0.15)' : 'transparent';
            }
        });
    });
</script>
{% endblock %}