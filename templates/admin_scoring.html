{% extends "layout.html" %}
{% block content %}
<div class="container-fluid py-3 px-2">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <h2 class="fw-900 uppercase text-accent m-0 fs-4">Admin Scoring</h2>
        <form action="{{ url_for('admin_scoring') }}" method="POST" class="w-100 w-md-auto">
            <input type="hidden" name="sync_all" value="1">
            <button type="submit" class="btn btn-outline-light btn-sm fw-900 uppercase ls-1 w-100">Sync Cast</button>
        </form>
    </div>

    <div class="pro-card p-2 p-md-4 border-secondary bg-black">
        <form action="{{ url_for('admin_scoring') }}" method="POST">
            <div class="row mb-3 align-items-end g-2">
                <div class="col-6 col-md-3">
                    <label class="x-small fw-900 uppercase text-white-50 mb-1 d-block">Week #</label>
                    <input type="number" name="week_num" id="weekNum" class="form-control bg-black text-white border-secondary"
                           value="{{ week }}" required onchange="window.location.href='{{ url_for('admin_scoring') }}?week=' + this.value">
                </div>
                <div class="col-12 col-md-9 text-md-end">
                    <div class="d-flex flex-wrap gap-1 justify-content-md-end">
                        {% for key, val in config.items() %}
                            <span class="badge bg-dark border border-secondary" style="font-size: 0.55rem;">
                                {{ key[:5]|upper }}: {{ val }}
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="table-responsive border-top border-secondary" style="max-height: 65vh; overflow-y: auto;">
                <table class="table table-dark table-hover align-middle m-0" id="scoringTable">
                    <thead class="sticky-top bg-black" style="z-index: 10;">
                        <tr class="x-small fw-900 uppercase ls-1 border-bottom border-white">
                            <th class="sticky-col bg-black py-3">Survivor</th>
                            <th class="text-center">Pts</th>
                            <th class="text-center text-danger">Out</th>
                            <th class="text-center">Surv</th>
                            <th class="text-center">Imm</th>
                            <th class="text-center">Rew</th>
                            <th class="text-center text-accent">Adv+</th>
                            <th class="text-center text-info">JRN</th>
                            <th class="text-center text-warning">PKT</th>
                            <th class="text-center">Mrg</th>
                            <th class="text-center">F5</th>
                            <th class="text-center">F3</th>
                            <th class="text-center text-accent">WIN</th>
                            <th class="text-center text-info">CRY</th>
                            <th class="text-center text-danger">QUIT</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in survivors if not s.is_out %}
                        {# Get existing stats for this specific survivor from the dictionary sent by Python #}
                        {% set s_stat = current_stats.get(s.id) %}
                        <tr class="border-bottom border-secondary-subtle">
                            <td class="sticky-col bg-black fw-bold text-white small">{{ s.name.split(' ')[0] }}</td>
                            <td class="text-center text-accent fw-bold small" id="total-{{ s.id }}">{{ s.points|round(1) }}</td>

                            <td class="text-center p-2">
                                <input type="checkbox" name="voted_out_{{ s.id }}" class="form-check-input border-danger">
                            </td>

                            {# Helper to render boxes that 'stick' based on DB state #}
                            {% macro render_box(prop, extra_class='') %}
                            <td class="text-center p-2">
                                <input type="checkbox"
                                       data-pid="{{ s.id }}"
                                       data-cat="{{ prop }}"
                                       class="form-check-input ajax-score {{ extra_class }}"
                                       {{ 'checked' if s_stat and getattr(s_stat, prop) else '' }}
                                       {{ 'disabled' if is_locked }}>
                            </td>
                            {% endmacro %}

                            {{ render_box('survived') }}
                            {{ render_box('immunity') }}
                            {{ render_box('reward') }}
                            {{ render_box('advantage', 'border-accent') }}
                            {{ render_box('journey', 'border-info') }}
                            {{ render_box('in_pocket', 'border-warning') }}
                            {{ render_box('merge') }}
                            {{ render_box('f5') }}
                            {{ render_box('f3') }}
                            {{ render_box('winner', 'border-accent') }}
                            {{ render_box('crying', 'border-info') }}
                            {{ render_box('quit', 'border-danger') }}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-3 sticky-bottom bg-black py-2">
                {% if is_locked %}
                    <div class="alert alert-warning fw-900 text-center uppercase py-3 m-0">Week {{ week }} is Locked ðŸ”’</div>
                {% else %}
                    <button type="submit" class="btn btn-accent w-100 fw-900 py-3 uppercase ls-2 shadow-lg">Finalize & Lock Week ðŸ”’</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<style>
    .sticky-col {
        position: sticky;
        left: 0;
        z-index: 5;
        border-right: 2px solid #ffffff !important;
        min-width: 80px;
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .form-check-input {
        width: 1.4rem;
        height: 1.4rem;
        background-color: #000;
        border: 2px solid #555;
        margin: 0;
        cursor: pointer;
    }

    .form-check-input:disabled { opacity: 0.3; cursor: not-allowed; }
    .form-check-input.border-warning:checked { background-color: #ffc107; border-color: #fff; }
    .form-check-input.border-accent:checked { background-color: var(--accent); border-color: #fff; }
    .form-check-input.border-info:checked { background-color: #0dcaf0; border-color: #fff; }
    .form-check-input.border-danger:checked { background-color: #dc3545; border-color: #fff; }

    .form-check-input:checked {
        background-color: var(--accent);
        border-color: #fff;
    }

    td { cursor: pointer; transition: background 0.2s; }
    td:hover { background: rgba(255, 255, 255, 0.1) !important; }

    .table-responsive::-webkit-scrollbar { height: 6px; }
    .table-responsive::-webkit-scrollbar-thumb { background: var(--accent); }

    @media (max-width: 768px) {
        .pro-card { border-radius: 0; border-inline: none; }
    }
</style>

<script>
    // 1. AJAX SCORING LOGIC
    document.querySelectorAll('.ajax-score').forEach(input => {
        input.addEventListener('change', async function() {
            if (this.disabled) return;

            const pId = this.dataset.pid;
            const cat = this.dataset.cat;
            const isChecked = this.checked;
            const week = document.getElementById('weekNum').value;

            try {
                const response = await fetch("{{ url_for('admin_scoring') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: pId,
                        category: cat,
                        state: isChecked,
                        week: week
                    })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById(`total-${pId}`).innerText = result.new_total;
                } else {
                    alert("Error: " + (result.error || "Unknown error"));
                    this.checked = !isChecked;
                }
            } catch (err) {
                console.error("AJAX Error:", err);
                this.checked = !isChecked;
            }
        });
    });

    // 2. CELL-CLICK TOGGLE
    document.querySelectorAll('#scoringTable td').forEach(cell => {
        cell.addEventListener('click', function(e) {
            if (this.classList.contains('sticky-col') || this.id.startsWith('total-')) return;
            if (e.target.type === 'checkbox') return;

            const cb = this.querySelector('input[type="checkbox"]');
            if (cb && !cb.disabled) {
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change'));
            }
        });
    });
</script>
{% endblock %}